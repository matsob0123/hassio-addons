ARG BUILD_FROM
FROM $BUILD_FROM

# Set shell
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Install dependencies
RUN apk add --no-cache \
    nodejs \
    npm \
    bash \
    git \
    ffmpeg \
    imagemagick \
    curl

# Set environment variables
ENV NODE_ENV=production \
    PISIGNAGE_DIR=/pisignage-server

# Create working directory
WORKDIR ${PISIGNAGE_DIR}

# Download piSignage server from docker-build branch
RUN git clone --branch docker-build --depth 1 \
    https://github.com/colloqi/pisignage-server.git ${PISIGNAGE_DIR}

# Install npm dependencies
RUN npm install --production

# Make wait-for-it.sh executable
RUN chmod +x ./wait-for-it.sh

# Copy run script
COPY run.sh /
RUN chmod a+x /run.sh

# Expose port
EXPOSE 3000

# Run
CMD ["/run.sh"]